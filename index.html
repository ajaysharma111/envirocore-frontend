<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EnviroCore</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="header">
  <h1>ðŸŒ± EnviroCore Dashboard</h1>
  <p>Campus Carbon Monitoring & Sustainability Insights</p>
  <button id="themeBtn">Toggle Dark Mode</button>
</div>

<section class="panel">
  <h2>Login</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
  <button id="logoutBtn">Logout</button>
  <p id="status">Not logged in</p>
</section>

<section class="panel">
  <h2>Add Building</h2>
  <input id="name" placeholder="Building name">
  <input id="elec" type="number" placeholder="Electricity (kWh)">
  <input id="water" type="number" placeholder="Water (liters)">
  <input id="paper" type="number" placeholder="Paper (kg)">
  <br>
  <button id="submitBtn" disabled>Add Building</button>
  <button id="clearBtn" class="danger" style="display:none;">Clear All</button>
</section>

<section class="panel">
  <h2>Buildings</h2>
  <div id="list"></div>
</section>

<section class="panel">
  <h2>Carbon Footprint</h2>
  <canvas id="carbonChart"></canvas>
  <canvas id="pieChart"></canvas>
</section>

<section class="panel">
  <h2>Recommendations</h2>
  <div id="recommendations"></div>
</section>

<section class="panel">
  <button id="pdfBtn">Download PDF</button>
  <button id="excelBtn">Export Excel</button>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdon6u4Rz37tWg1eKLtxkmMGpCjn4grr8",
  authDomain: "envirocore-b75f3.firebaseapp.com",
  projectId: "envirocore-b75f3",
  storageBucket: "envirocore-b75f3.firebasestorage.app",
  messagingSenderId: "233204598126",
  appId: "1:233204598126:web:f6cbcdb617e7152a0bed7f"
};

const API = "https://envirocore-backend.onrender.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

let barChart = null;
let pieChartInstance = null;

window.addEventListener("DOMContentLoaded", () => {

  const themeBtn = document.getElementById("themeBtn");
  const loginBtn = document.getElementById("loginBtn");
  const signupBtn = document.getElementById("signupBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const submitBtn = document.getElementById("submitBtn");
  const clearBtn = document.getElementById("clearBtn");
  const pdfBtn = document.getElementById("pdfBtn");
  const excelBtn = document.getElementById("excelBtn");
  const statusEl = document.getElementById("status");

  themeBtn.onclick = () => document.body.classList.toggle("dark");
  loginBtn.onclick = loginUser;
  signupBtn.onclick = signupUser;
  logoutBtn.onclick = logoutUser;
  submitBtn.onclick = submitData;
  clearBtn.onclick = clearAll;
  pdfBtn.onclick = downloadPDF;
  excelBtn.onclick = exportExcel;

  onAuthStateChanged(auth, user => {
    if (user) {
      statusEl.textContent = "Logged in as " + user.email;
      submitBtn.disabled = false;
      clearBtn.style.display = "inline";
      loadBuildings();
    } else {
      statusEl.textContent = "Not logged in";
      submitBtn.disabled = true;
      clearBtn.style.display = "none";
      list.innerHTML = "";
    }
  });
});

async function signupUser() {
  try {
    await createUserWithEmailAndPassword(auth, email.value, password.value);
    alert("Account created!");
  } catch (e) { alert(e.message); }
}

async function loginUser() {
  try {
    await signInWithEmailAndPassword(auth, email.value, password.value);
    alert("Login successful!");
  } catch (e) { alert(e.message); }
}

async function logoutUser() {
  await signOut(auth);
  alert("Logged out");
}

function getInputs() {
  return {
    name: document.getElementById("name").value.trim(),
    electricity_kwh: Number(document.getElementById("elec").value) || 0,
    water_liters: Number(document.getElementById("water").value) || 0,
    paper_kg: Number(document.getElementById("paper").value) || 0
  };
}

async function submitData() {
  const d = getInputs();
  if (!d.name) return alert("Enter building name");

  await fetch(`${API}/building`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(d)
  });

  ["name","elec","water","paper"].forEach(id => document.getElementById(id).value = "");
  loadBuildings();
}

async function clearAll() {
  if (!confirm("Clear all data?")) return;
  await fetch(`${API}/buildings`, { method: "DELETE" });
  loadBuildings();
}

async function loadBuildings() {
  const res = await fetch(`${API}/buildings`);
  const data = await res.json();

  document.getElementById("list").innerHTML = data.map(b => `
    <div class="card">
      <b>${b.name}</b><br>${b.carbon.toFixed(1)} kg COâ‚‚
    </div>`).join("");

  const labels = data.map(b => b.name);
  const values = data.map(b => b.carbon);

  barChart?.destroy();
  pieChartInstance?.destroy();

  barChart = new Chart(carbonChart, { type: "bar", data: { labels, datasets:[{label:"kg COâ‚‚",data:values}]}});
  pieChartInstance = new Chart(pieChart, { type: "pie", data: { labels, datasets:[{data:values}]} });

  generateRecommendations(data);
}

function generateRecommendations(data) {
  const total = data.reduce((s,b)=>s+b.carbon,0)||1;
  recommendations.innerHTML = data.map(b=>{
    const save=b.carbon*0.2;
    return `<div class="rec">
      <b>${b.name}</b><br>
      Save ${save.toFixed(0)} kg by switching to LED<br>
      â†’ ${(b.carbon-save).toFixed(0)} kg
    </div>`;
  }).join("");
}

function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(document.getElementById("recommendations").innerText || "No data", 10, 10);
  doc.save("envirocore.pdf");
}

async function exportExcel() {
  const data = await (await fetch(`${API}/buildings`)).json();
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Buildings");
  XLSX.writeFile(wb, "envirocore.xlsx");
}
</script>

</body>
</html>