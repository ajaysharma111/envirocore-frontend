<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EnviroCore</title>

<link rel="stylesheet" href="styles.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-font@1.0.0/dist/roboto-normal.js"></script>
</head>
<body>

<div class="header">
  <h1>ðŸŒ± EnviroCore Dashboard</h1>
  <button id="themeBtn">Toggle Dark Mode</button>
</div>

<section class="panel">
  <h3>Login</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password">
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
  <button id="logoutBtn">Logout</button>
  <p id="status">Not logged in</p>
</section>

<section class="panel">
  <h3>Add Building</h3>
  <input id="name" placeholder="Building name">
  <input id="elec" type="number" placeholder="Electricity (kWh)">
  <input id="water" type="number" placeholder="Water (liters)">
  <input id="paper" type="number" placeholder="Paper (kg)">
  <button id="submitBtn" disabled>Add Building</button>
  <button id="clearBtn" style="display:none;">Clear All</button>
</section>

<section class="panel">
  <h3>Buildings</h3>
  <div id="list"></div>
</section>

<section class="panel">
  <h3>Carbon Footprint</h3>
  <div class="chart-box">
    <canvas id="carbonChart"></canvas>
  </div>
  <div class="chart-box small">
    <canvas id="pieChart"></canvas>
  </div>
</section>

<section class="panel">
  <h3>Recommendations</h3>
  <div id="recommendations"></div>
</section>

<section class="panel">
  <button id="pdfBtn">Download PDF</button>
  <button id="excelBtn">Export Excel</button>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword, signOut,
  onAuthStateChanged, createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdon6u4Rz37tWg1eKLtxkmMGpCjn4grr8",
  authDomain: "envirocore-b75f3.firebaseapp.com",
  projectId: "envirocore-b75f3",
  storageBucket: "envirocore-b75f3.firebasestorage.app",
  messagingSenderId: "233204598126",
  appId: "1:233204598126:web:f6cbcdb617e7152a0bed7f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const API = "https://envirocore-backend.onrender.com";
const el = id => document.getElementById(id);

let uid = null;
let barChart = null;
let pieChart = null;

el("themeBtn").onclick = () => document.body.classList.toggle("dark");
el("loginBtn").onclick = () => signInWithEmailAndPassword(auth, el("email").value, el("password").value);
el("signupBtn").onclick = () => createUserWithEmailAndPassword(auth, el("email").value, el("password").value);
el("logoutBtn").onclick = () => signOut(auth);
el("submitBtn").onclick = submit;
el("clearBtn").onclick = clearAll;
el("pdfBtn").onclick = downloadPDF;
el("excelBtn").onclick = exportExcel;

onAuthStateChanged(auth, user => {
  if (user) {
    uid = user.uid;
    el("status").textContent = "Logged in as " + user.email;
    el("submitBtn").disabled = false;
    el("clearBtn").style.display = "inline";
    load();
  } else {
    uid = null;
    el("status").textContent = "Not logged in";
    el("submitBtn").disabled = true;
    el("clearBtn").style.display = "none";
    el("list").innerHTML = "";
    el("recommendations").innerHTML = "";
  }
});

async function submit() {
  if (!uid) return alert("Login first");
  const data = {
    name: el("name").value,
    electricity_kwh: +el("elec").value || 0,
    water_liters: +el("water").value || 0,
    paper_kg: +el("paper").value || 0,
    uid
  };
  if (!data.name) return alert("Enter building name");

  await fetch(API + "/building", {
    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data)
  });

  el("name").value = el("elec").value = el("water").value = el("paper").value = "";
  load();
}

async function clearAll() {
  if (!confirm("Clear all data?")) return;
  await fetch(API + "/buildings?uid=" + uid, { method: "DELETE" });
  load();
}

async function load() {
  const res = await fetch(API + "/buildings?uid=" + uid);
  const data = await res.json();

  el("list").innerHTML = data.map(b => `<div class="card">${b.name} â€” ${b.carbon.toFixed(1)} kg</div>`).join("");

  barChart?.destroy();
  pieChart?.destroy();

  barChart = new Chart(el("carbonChart"), {
    type: "bar",
    options: { responsive: true, maintainAspectRatio: false },
    data: { labels: data.map(b => b.name), datasets: [{ label: "kg COâ‚‚", data: data.map(b => b.carbon) }] }
  });

  pieChart = new Chart(el("pieChart"), {
    type: "pie",
    options: { responsive: true, maintainAspectRatio: false },
    data: { labels: data.map(b => b.name), datasets: [{ data: data.map(b => b.carbon) }] }
  });

  generateRecommendations(data);
}

function generateRecommendations(data) {
  const totalCampus = data.reduce((sum, b) => sum + b.carbon, 0);

  let html = `
    <div class="rec">
      <b>Total Campus Emissions:</b> ${totalCampus.toFixed(1)} kg COâ‚‚
    </div><br>
  `;

  data.forEach(b => {
    let actions = [];
    let save = 0;

    // Electricity
    if (b.electricity_kwh > 100) {
      const s = b.electricity_kwh * 0.5 * 0.20; // 20% of electricity carbon
      save += s;
      actions.push(`ðŸ’¡ Switch CFL â†’ LED lighting (save ${s.toFixed(1)} kg COâ‚‚)`);
    }

    // Water
    if (b.water_liters > 500) {
      const s = b.water_liters * 0.002 * 0.30; // 30% of water carbon
      save += s;
      actions.push(`ðŸš° Normal taps â†’ Sensor taps (save ${s.toFixed(1)} kg COâ‚‚)`);
    }

    // Paper
    if (b.paper_kg > 10) {
      const s = b.paper_kg * 1.5 * 0.40; // 40% of paper carbon
      save += s;
      actions.push(`ðŸ“„ Paper printing â†’ Digital docs (save ${s.toFixed(1)} kg COâ‚‚)`);
    }

    const wasted = save;
    const future = b.carbon + wasted;

    html += `
      <div class="rec">
        <b>${b.name}</b><br>
        Current Emissions: ${b.carbon.toFixed(1)} kg COâ‚‚<br><br>

        ${actions.length ? actions.join("<br>") : "âœ… Already optimized â€” no major waste detected"}<br><br>

        <b>If you take action:</b> You reduce ${save.toFixed(1)} kg COâ‚‚ â†’ New total ${(b.carbon - save).toFixed(1)} kg<br>
        <b>If you donâ€™t:</b> You waste ${wasted.toFixed(1)} kg COâ‚‚ â†’ Future total ${future.toFixed(1)} kg
      </div><br>
    `;
  });

  document.getElementById("recommendations").innerHTML = html;
}


function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Use Unicode font
  doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
  doc.setFont("Roboto");

  const text = document.getElementById("recommendations").innerText || "No data";

  const lines = doc.splitTextToSize(text, 180);
  doc.text(lines, 10, 10);

  doc.save("envirocore.pdf");
}

async function exportExcel() {
  const res = await fetch(API + "/buildings?uid=" + uid);
  const data = await res.json();
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Buildings");
  XLSX.writeFile(wb, "envirocore.xlsx");
}
</script>
</body>
</html>