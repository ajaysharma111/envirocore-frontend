<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EnviroCore</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>

<h1>ðŸŒ± EnviroCore</h1>

<h2>Login / Signup</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
<button id="signupBtn">Sign Up</button>
<button id="logoutBtn">Logout</button>
<p id="status">Not logged in</p>

<hr>

<h2>Add Building</h2>
<input id="name" placeholder="Building name">
<input id="elec" type="number" placeholder="Electricity">
<input id="water" type="number" placeholder="Water">
<input id="paper" type="number" placeholder="Paper">
<button id="submitBtn" disabled>Add Building</button>
<button id="clearBtn" style="display:none;">Clear All</button>

<h2>Buildings</h2>
<div id="list"></div>

<h2>Carbon Chart</h2>
<canvas id="carbonChart"></canvas>

<h2>Carbon Share</h2>
<div style="width:240px;height:240px;margin:auto;">
<canvas id="pieChart"></canvas>
</div>

<h2>Recommendations</h2>
<div id="recommendations"></div>

<button id="pdfBtn">Download PDF</button>
<button id="excelBtn">Export Excel</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdon6u4Rz37tWg1eKLtxkmMGpCjn4grr8",
  authDomain: "envirocore-b75f3.firebaseapp.com",
  projectId: "envirocore-b75f3",
  storageBucket: "envirocore-b75f3.firebasestorage.app",
  messagingSenderId: "233204598126",
  appId: "1:233204598126:web:f6cbcdb617e7152a0bed7f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const API = "https://envirocore-backend.onrender.com";

const emailEl = document.getElementById("email");
const passEl = document.getElementById("password");

let currentUID = null;
let barChart = null;
let pieChart = null;

loginBtn.onclick = loginUser;
signupBtn.onclick = signupUser;
logoutBtn.onclick = logoutUser;
submitBtn.onclick = submitData;
clearBtn.onclick = clearAll;
pdfBtn.onclick = downloadPDF;
excelBtn.onclick = exportExcel;

onAuthStateChanged(auth, user => {
  if (user) {
    currentUID = user.uid;
    status.textContent = "Logged in as " + user.email;
    submitBtn.disabled = false;
    clearBtn.style.display = "inline";
    loadBuildings();
  } else {
    currentUID = null;
    status.textContent = "Not logged in";
    submitBtn.disabled = true;
    clearBtn.style.display = "none";
    list.innerHTML = "";
  }
});

async function signupUser() {
  await createUserWithEmailAndPassword(auth, emailEl.value, passEl.value);
  alert("Account created!");
}

async function loginUser() {
  await signInWithEmailAndPassword(auth, emailEl.value, passEl.value);
}

async function logoutUser() {
  await signOut(auth);
}

function getInputs() {
  return {
    name: name.value.trim(),
    electricity_kwh: +elec.value || 0,
    water_liters: +water.value || 0,
    paper_kg: +paper.value || 0
  };
}

async function submitData() {
  const d = getInputs();
  if (!d.name) return alert("Enter building name");

  await fetch(API + "/building", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ ...d, uid: currentUID })
  });

  name.value = elec.value = water.value = paper.value = "";
  loadBuildings();
}

async function clearAll() {
  if (!confirm("Clear all your data?")) return;
  await fetch(API + "/buildings?uid=" + currentUID, { method: "DELETE" });
  loadBuildings();
}

async function loadBuildings() {
  const data = await (await fetch(API + "/buildings?uid=" + currentUID)).json();

  list.innerHTML = data.map(b =>
    `<div>${b.name} â€” ${b.carbon.toFixed(1)} kg</div>`
  ).join("");

  const labels = data.map(b => b.name);
  const values = data.map(b => b.carbon);

  barChart?.destroy();
  barChart = new Chart(carbonChart, {
    type: "bar",
    data: { labels, datasets:[{label:"kg COâ‚‚", data: values}] }
  });

  pieChart?.destroy();
  pieChart = new Chart(pieChartEl, {
    type: "pie",
    data: { labels, datasets:[{ data: values }] },
    options: { responsive:true, maintainAspectRatio:false }
  });

  generateRecommendations(data);
}

function generateRecommendations(data) {
  recommendations.innerHTML = data.map(b => {
    let saved = 0;
    let recs = [];

    if (b.electricity_kwh > 0) {
      const s = b.electricity_kwh * 0.5 * 0.2;
      saved += s;
      recs.push(`âš¡ Reduce electricity â†’ save ${s.toFixed(1)} kg`);
    }
    if (b.water_liters > 0) {
      const s = b.water_liters * 0.002 * 0.15;
      saved += s;
      recs.push(`ðŸš¿ Reduce water â†’ save ${s.toFixed(1)} kg`);
    }
    if (b.paper_kg > 0) {
      const s = b.paper_kg * 1.5 * 0.1;
      saved += s;
      recs.push(`ðŸ“„ Reduce paper â†’ save ${s.toFixed(1)} kg`);
    }

    return `
      <div>
        <b>${b.name}</b><br>
        Current: ${b.carbon.toFixed(1)} kg<br>
        ${recs.join("<br>")}
        <br><b>After:</b> ${(b.carbon - saved).toFixed(1)} kg
      </div>`;
  }).join("");
}

function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(recommendations.innerText || "No data", 10, 10);
  doc.save("envirocore.pdf");
}

async function exportExcel() {
  const data = await (await fetch(API + "/buildings?uid=" + currentUID)).json();
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Buildings");
  XLSX.writeFile(wb, "envirocore.xlsx");
}
</script>

</body>
</html>